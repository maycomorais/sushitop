<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Sushi Top</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #FF441F; --dark: #2c3e50; --light: #ecf0f1; --success: #2ecc71; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; background: #f4f7f6; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: var(--dark); color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand { padding: 20px; text-align: center; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #34495e; }
        .menu { flex: 1; padding-top: 20px; overflow-y: auto; }
        .menu-item { padding: 15px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.3s; color: #bdc3c7; }
        .menu-item:hover, .menu-item.active { background: var(--primary); color: white; }
        
        /* Conte√∫do */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }

        /* Cards e Pain√©is */
        .header-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .kpi-title { font-size: 0.9rem; color: #7f8c8d; margin-bottom: 5px; }
        .kpi-value { font-size: 1.5rem; font-weight: bold; color: var(--dark); }
        .kpi-green { color: #27ae60; } .kpi-red { color: #c0392b; }

        /* Tabelas Responsivas */
        .table-container { overflow-x: auto; background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #555; white-space: nowrap; }
        tr:hover { background: #f1f1f1; }
        
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; display: inline-block; }
        .st-pendente { background: #ffeaa7; color: #d35400; }
        .st-aceito { background: #81ecec; color: #00cec9; }
        .st-entregue { background: #55efc4; color: #00b894; }

        /* Bot√µes */
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s; white-space: nowrap; display: inline-flex; align-items: center; gap: 5px; color: white;}
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-info { background: #3498db; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        
        /* A√ß√µes Tabela */
        .actions-cell { display: flex; gap: 5px; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 25px; border-radius: 10px; width: 600px; max-width: 95%; max-height: 90vh; overflow-y: auto; position: relative; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

        /* Builder (Poke) */
        .builder-box { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px dashed #ccc; margin-top: 10px; }
        .etapa-item { background: white; padding: 10px; border-radius: 5px; border: 1px solid #eee; margin-bottom: 10px; }
        .etapa-header { display: flex; gap: 10px; margin-bottom: 5px; }
        .etapa-ingredientes { width: 100%; font-size: 0.85rem; height: 60px; border: 1px solid #ddd; padding: 5px; }

        /* Mobile */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; flex-direction: row; padding: 10px; overflow-x: auto; align-items: center; }
            .brand { display: none; }
            .menu { padding: 0; display: flex; gap: 5px; }
            .menu-item { padding: 10px; font-size: 0.8rem; border-radius: 8px; white-space: nowrap; }
            .mobile-hide { display: none; }
            .main-content { padding: 15px; overflow: visible; }
            .actions-cell { flex-direction: column; }
            .btn-sm { width: 100%; justify-content: center; margin-bottom: 2px; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">SUSHI ADMIN</div>
        <div class="menu">
            <div class="menu-item active" onclick="showTab('dashboard')"><i class="fas fa-home"></i><span class="mobile-hide"> Vis√£o</span></div>
            <div class="menu-item" onclick="showTab('pedidos')"><i class="fas fa-motorcycle"></i><span class="mobile-hide"> Pedidos</span></div>
            <div class="menu-item" onclick="showTab('produtos')"><i class="fas fa-utensils"></i><span class="mobile-hide"> Produtos</span></div>
            <div class="menu-item" onclick="showTab('categorias')"><i class="fas fa-tags"></i><span class="mobile-hide"> Categorias</span></div>
            <div class="menu-item" onclick="showTab('motoboys')"><i class="fas fa-helmet-safety"></i><span class="mobile-hide"> Motoboys</span></div>
            <div class="menu-item" onclick="showTab('configuracoes')"><i class="fas fa-cog"></i><span class="mobile-hide"> Config</span></div>
            
            <div class="menu-item" id="menu-financeiro" style="display:none;" onclick="showTab('financeiro')">
                <i class="fas fa-chart-line"></i><span class="mobile-hide"> Finan.</span>
            </div>
            
            <div class="menu-item" onclick="logout()" style="color:#e74c3c; margin-left: auto;">
                <i class="fas fa-sign-out-alt"></i>
            </div>
        </div>
    </div>

    <div class="main-content">
        
        <div id="dashboard" class="tab-content active">
            <div class="header-title"><h2>Vis√£o Geral</h2><span id="user-cargo">...</span></div>
            <div class="card-grid">
                <div class="kpi-card"><div class="kpi-title">Vendas Hoje</div><div class="kpi-value kpi-green" id="kpi-vendas">Gs 0</div></div>
                <div class="kpi-card"><div class="kpi-title">Entregues</div><div class="kpi-value" id="kpi-pedidos">0</div></div>
                <div class="kpi-card"><div class="kpi-title">Custo Motoboy</div><div class="kpi-value kpi-red" id="kpi-moto">Gs 0</div></div>
            </div>
            <h3>üèÜ Top 5 Mais Vendidos</h3>
            <div class="table-container">
                <table id="tabela-ranking"><thead><tr><th>Produto</th><th>Vendas Totais</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div id="pedidos" class="tab-content">
            <div class="header-title">
                <h2>Gest√£o de Pedidos</h2>
                <button class="btn btn-primary" onclick="carregarPedidos()"><i class="fas fa-sync"></i> Atualizar</button>
            </div>
            
            <div class="box-envio-zap" style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; border: 1px solid #eee;">
                <strong><i class="fab fa-whatsapp"></i> Rota:</strong>
                <select id="sel-motoboy" class="form-control" style="width: auto; flex: 1;">
                    <option value="">Selecione o Motoboy...</option>
                </select>
                <button class="btn btn-success" onclick="enviarRotaZap()">Enviar</button>
            </div>

            <div class="table-container">
                <table>
                    <thead><tr><th width="30"><input type="checkbox" onchange="toggleTodos(this)"></th><th>ID</th><th>Cliente</th><th>Status</th><th>Valor</th><th>Pag</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="lista-pedidos"></tbody>
                </table>
            </div>
        </div>

        <div id="produtos" class="tab-content">
            <div class="header-title"><h2>Produtos</h2><button class="btn btn-primary" onclick="abrirModalProduto()"><i class="fas fa-plus"></i> Novo</button></div>
            <div class="table-container"><table><thead><tr><th>Img</th><th>Nome</th><th>Cat</th><th>Pre√ßo</th><th>A√ß√µes</th></tr></thead><tbody id="lista-produtos"></tbody></table></div>
        </div>

        <div id="categorias" class="tab-content">
            <div class="header-title"><h2>Categorias</h2><button class="btn btn-primary" onclick="abrirModalCategoria()"><i class="fas fa-plus"></i> Nova</button></div>
            <div class="table-container"><table><thead><tr><th>Slug</th><th>Nome</th><th>Ordem</th><th>A√ß√µes</th></tr></thead><tbody id="lista-categorias"></tbody></table></div>
        </div>

        <div id="motoboys" class="tab-content">
             <div class="header-title"><h2>Motoboys</h2><button class="btn btn-primary" onclick="abrirModalMoto()"><i class="fas fa-plus"></i> Novo</button></div>
             <div class="table-container"><table><thead><tr><th>Nome</th><th>Telefone</th><th>A√ß√µes</th></tr></thead><tbody id="lista-motos"></tbody></table></div>
        </div>

        <div id="configuracoes" class="tab-content">
            <h2>Configura√ß√µes</h2>
            <div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px;">
                <div class="form-group"><label>Loja Aberta?</label>
                    <select id="cfg-aberta" class="form-control"><option value="true">SIM</option><option value="false">N√ÉO</option></select>
                </div>
                <div class="form-group"><label>Cota√ß√£o Real (R$)</label><input type="number" id="cfg-cotacao" class="form-control"></div>
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex:1"><label>Abre</label><input type="time" id="cfg-hora-abre" class="form-control"></div>
                    <div class="form-group" style="flex:1"><label>Fecha</label><input type="time" id="cfg-hora-fecha" class="form-control"></div>
                </div>
                <button class="btn btn-success" onclick="salvarConfiguracoes()">Salvar</button>
            </div>
        </div>

        <div id="financeiro" class="tab-content">
            <h2>Financeiro Detalhado</h2>
            <div class="card-grid">
                <div class="kpi-card"><div class="kpi-title">Pix</div><div class="kpi-value" id="fin-pix">0</div></div>
                <div class="kpi-card"><div class="kpi-title">Cart√£o</div><div class="kpi-value" id="fin-cartao">0</div></div>
                <div class="kpi-card"><div class="kpi-title">Efetivo</div><div class="kpi-value" id="fin-efetivo">0</div></div>
                <div class="kpi-card" style="border-left:5px solid #2ecc71"><div class="kpi-title">LUCRO L√çQUIDO</div><div class="kpi-value" id="fin-liquido">0</div></div>
            </div>
        </div>

    </div>

    <div id="modal-produto" class="modal-overlay">
        <div class="modal-box">
            <h3>Produto</h3>
            <input type="hidden" id="prod-id">
            <div class="form-group"><label>Nome</label><input type="text" id="prod-nome" class="form-control"></div>
            <div class="form-group"><label>Descri√ß√£o</label><input type="text" id="prod-desc" class="form-control"></div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label>Pre√ßo</label><input type="number" id="prod-preco" class="form-control"></div>
                <div class="form-group" style="flex:1"><label>Categoria</label><select id="prod-cat" class="form-control"></select></div>
            </div>

            <div class="form-group">
                <label>Imagem</label>
                <div style="border: 2px dashed #ccc; padding: 15px; text-align: center; border-radius: 8px; position: relative;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 1.5rem; color: #888;"></i>
                    <p style="margin:5px 0; font-size:0.9rem; color:#666;">Clique para escolher</p>
                    <input type="file" id="prod-img-file" accept="image/*" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;" onchange="previewUpload(this)">
                </div>
                <div id="box-preview" style="display:none; text-align:center; margin-top:5px;">
                    <img id="img-preview" src="" style="max-height:100px; border-radius:4px;">
                    <div id="status-upload" style="font-size:0.8rem; color:blue;"></div>
                </div>
                <input type="hidden" id="prod-img"> </div>
            
            <div class="form-group" style="background:#f0faff; padding:10px; border-radius:5px;">
                <label style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="prod-montavel" onchange="toggleBuilder()"> Ativar Montagem (Poke/Salada)
                </label>
                <div id="builder-area" class="builder-box" style="display:none;">
                    <div id="builder-steps"></div>
                    <button class="btn btn-sm btn-primary" style="margin-top:10px;" onclick="addBuilderStep()">+ Etapa</button>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-danger" onclick="fecharModal('modal-produto')">Cancelar</button>
                <button class="btn btn-success" onclick="salvarProduto()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modal-cat" class="modal-overlay"><div class="modal-box"><h3>Categoria</h3><div class="form-group"><label>Slug</label><input type="text" id="cat-slug" class="form-control"></div><div class="form-group"><label>Nome</label><input type="text" id="cat-nome" class="form-control"></div><div class="form-group"><label>Ordem</label><input type="number" id="cat-ordem" class="form-control"></div><div class="modal-actions"><button class="btn btn-success" onclick="salvarCategoria()">Salvar</button></div></div></div>
    
    <div id="modal-moto" class="modal-overlay"><div class="modal-box"><h3>Motoboy</h3><input type="hidden" id="moto-id"><div class="form-group"><label>Nome</label><input type="text" id="moto-nome" class="form-control"></div><div class="form-group"><label>Telefone</label><input type="text" id="moto-tel" class="form-control"></div><div class="modal-actions"><button class="btn btn-success" onclick="salvarMotoboy()">Salvar</button></div></div></div>

    <script src="supabaseClient.js"></script>

    <script>
        const TAXA_MOTOBOY = 5000; 
        const AJUDA_COMBUSTIVEL = 20000; 
        const COORD_LOJA = { lat: -25.2365803, lng: -57.5380816 };

        let perfilUsuario = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if(typeof checkUser === 'function') {
                const session = await checkUser();
                const { data: perfil } = await supa.from('perfis_acesso').select('cargo').eq('id', session.user.id).single();
                perfilUsuario = perfil ? perfil.cargo : 'gerente';
                document.getElementById('user-cargo').innerText = perfilUsuario.toUpperCase();
                if(perfilUsuario === 'dono') document.getElementById('menu-financeiro').style.display = 'flex';
                carregarDashboard();
                carregarMotoboysSelect();
            }
        });

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
            if(tabId === 'pedidos') carregarPedidos();
            if(tabId === 'produtos') carregarProdutos();
            if(tabId === 'categorias') carregarCategorias();
            if(tabId === 'motoboys') carregarMotoboys();
            if(tabId === 'configuracoes') carregarConfiguracoes();
            if(tabId === 'financeiro') calcularFinanceiro();
        }

        // --- PEDIDOS ---
        async function carregarPedidos() {
            const { data: pedidos, error } = await supa.from('pedidos').select('*, clientes(nome, telefone)').order('data_pedido', { ascending: false }).limit(50);
            const tbody = document.getElementById('lista-pedidos');
            tbody.innerHTML = '';
            
            if(pedidos) {
                pedidos.forEach(p => {
                    const classeStatus = `st-${p.status}`;
                    const nomeCli = p.clientes ? p.clientes.nome : 'Cliente';
                    tbody.innerHTML += `
                        <tr>
                            <td><input type="checkbox" class="check-pedido" value='${JSON.stringify(p).replace(/'/g, "'")}'></td>
                            <td>#${p.uid_temporal || p.id}</td>
                            <td>${nomeCli}</td>
                            <td><span class="status-badge ${classeStatus}">${p.status.toUpperCase()}</span></td>
                            <td>Gs ${p.total_geral.toLocaleString('es-PY')}</td>
                            <td>${p.forma_pagamento}</td>
                            <td class="actions-cell">
                                <button class="btn btn-sm btn-info" onclick="imprimirPedido(${p.id})" title="Imprimir"><i class="fas fa-print"></i></button>
                                <button class="btn btn-sm btn-success" onclick="mudarStatus(${p.id}, 'aceito')" title="Aceitar"><i class="fas fa-check"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="mudarStatus(${p.id}, 'cancelado')" title="Cancelar"><i class="fas fa-times"></i></button>
                            </td>
                        </tr>
                    `;
                });
            }
        }
        
        async function mudarStatus(id, novoStatus) {
            if(!confirm(`Mudar status para ${novoStatus}?`)) return;
            await supa.from('pedidos').update({ status: novoStatus }).eq('id', id);
            carregarPedidos();
        }

        async function imprimirPedido(id) {
            const { data: p } = await supa.from('pedidos').select('*, clientes(nome, telefone)').eq('id', id).single();
            if(!p) return;
            
            const dados = {
                id: p.uid_temporal,
                cliente: { nome: p.clientes?.nome, tel: p.clientes?.telefone },
                entrega: { tipo: p.tipo_entrega, ref: p.endereco_entrega },
                itens: p.itens.map(i => ({ q: i.qtd, n: i.nome, p: i.preco, m: i.montagem, o: i.obs })),
                valores: { sub: p.subtotal, frete: p.frete_cobrado_cliente, total: p.total_geral },
                pagamento: { metodo: p.forma_pagamento, obs: p.obs_pagamento },
                factura: p.dados_factura
            };
            
            const jsonStr = JSON.stringify(dados);
            const base64 = btoa(unescape(encodeURIComponent(jsonStr)));
            window.open(`imprimir.html?d=${base64}`, 'Print', 'width=400,height=600');
        }

        function enviarRotaZap() {
            const checks = document.querySelectorAll('.check-pedido:checked');
            const selMoto = document.getElementById('sel-motoboy');
            
            if(checks.length === 0 || !selMoto.value) return alert("Selecione pelo menos um pedido e o motoboy!");
            const opt = selMoto.options[selMoto.selectedIndex];
            
            let msg = `üõµ *ROTA - ${opt.dataset.nome.toUpperCase()}*\n\n`;
            let coords = [];

            checks.forEach(chk => {
                const p = JSON.parse(chk.value);
                
                // Atualiza status
                supa.from('pedidos').update({ status: 'entregue', motoboy_id: selMoto.value }).eq('id', p.id).then();

                msg += `üì¶ *PEDIDO #${p.uid_temporal}*\n`;
                
                // --- CORRE√á√ÉO: DADOS DO CLIENTE ---
                // Se por acaso o cliente foi deletado do banco, evita erro mostrando 'Cliente'
                const nomeCli = p.clientes ? p.clientes.nome : 'Cliente';
                const telCli = p.clientes ? p.clientes.telefone : 'Sem Tel';
                
                msg += `üë§ ${nomeCli}\n`;
                msg += `üìû ${telCli}\n`;
                // -----------------------------------

                if(p.geo_lat && p.geo_lng) {
                    msg += `üìç Maps: https://www.google.com/maps/search/?api=1&query=$${p.geo_lat},${p.geo_lng}\n`;
                    coords.push(`${p.geo_lat},${p.geo_lng}`);
                } else {
                    msg += `üè† End: ${p.endereco_entrega}\n`;
                }
                
                msg += `üí∞ *Cobrar: Gs ${p.total_geral.toLocaleString('es-PY')}*\n`;
                msg += `üí≥ Pagamento: ${p.forma_pagamento}`;
                
                // L√≥gica de Troco Inteligente (Mantida)
                if(p.forma_pagamento === 'Efetivo' && p.obs_pagamento) {
                    let valorPago = parseInt(p.obs_pagamento.replace(/\D/g, '')) || 0;
                    if(valorPago > 0 && valorPago < 1000) valorPago = valorPago * 1000;
                    
                    const troco = valorPago - p.total_geral;

                    msg += `\nüíµ Receber: Gs ${valorPago.toLocaleString('es-PY')}`;
                    if(troco >= 0) {
                        msg += `\nüîÑ *LEVAR TROCO: Gs ${troco.toLocaleString('es-PY')}*`;
                    } else {
                        msg += `\n‚ö†Ô∏è Faltam: Gs ${Math.abs(troco).toLocaleString('es-PY')}`;
                    }
                }
                
                msg += `\n--------------------------\n`;
            });

            if(coords.length > 0) {
                const rotaUrl = `https://www.google.com/maps/dir/$${COORD_LOJA.lat},${COORD_LOJA.lng}/${coords.join('/')}`;
                msg += `\nüó∫Ô∏è *ROTA GOOGLE:*\n${rotaUrl}`;
            }

            window.open(`https://wa.me/${opt.dataset.tel}?text=${encodeURIComponent(msg)}`, '_blank');
            
            setTimeout(() => carregarPedidos(), 1000);
        }

        // --- PRODUTOS & UPLOAD ---
        async function carregarProdutos() {
            const { data } = await supa.from('produtos').select('*').order('nome');
            const tb = document.getElementById('lista-produtos'); tb.innerHTML = '';
            data.forEach(p => {
                tb.innerHTML += `<tr><td><img src="${p.imagem_url}" width="30"></td><td>${p.nome}</td><td>${p.categoria_slug}</td><td>Gs ${p.preco.toLocaleString()}</td><td class="actions-cell"><button class="btn btn-sm btn-primary" onclick='editarProduto(${JSON.stringify(p).replace(/'/g, "&#39;")})'><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger" onclick="deletarProduto(${p.id})"><i class="fas fa-trash"></i></button></td></tr>`;
            });
            carregarSelectCategorias();
        }

        function previewUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('img-preview').src = e.target.result;
                    document.getElementById('box-preview').style.display = 'block';
                    document.getElementById('status-upload').innerText = "Imagem Pronta para Envio";
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function salvarProduto() {
            const btn = event.target; btn.innerText = "Salvando..."; btn.disabled = true;
            try {
                const id = document.getElementById('prod-id').value;
                const fileInput = document.getElementById('prod-img-file');
                let urlFinal = document.getElementById('prod-img').value;

                if(fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const nomeArq = Date.now() + '-' + file.name.replace(/\s+/g, '-');
                    await supa.storage.from('produtos').upload(nomeArq, file);
                    const { data } = supa.storage.from('produtos').getPublicUrl(nomeArq);
                    urlFinal = data.publicUrl;
                }

                const isM = document.getElementById('prod-montavel').checked;
                let mJson = [];
                if(isM) {
                    document.querySelectorAll('.etapa-item').forEach(div => {
                        mJson.push({
                            titulo: div.querySelector('.step-titulo').value,
                            max: parseInt(div.querySelector('.step-max').value),
                            itens: div.querySelector('.step-itens').value.split(',').map(s=>s.trim()).filter(s=>s)
                        });
                    });
                }

                const dados = {
                    nome: document.getElementById('prod-nome').value,
                    descricao: document.getElementById('prod-desc').value,
                    preco: parseFloat(document.getElementById('prod-preco').value),
                    categoria_slug: document.getElementById('prod-cat').value,
                    imagem_url: urlFinal,
                    e_montavel: isM,
                    montagem_config: mJson,
                    ativo: true
                };

                if(id) await supa.from('produtos').update(dados).eq('id', id);
                else await supa.from('produtos').insert([dados]);
                
                fecharModal('modal-produto'); carregarProdutos();

            } catch(e) { alert("Erro: " + e.message); }
            finally { btn.innerText = "Salvar"; btn.disabled = false; }
        }

        function editarProduto(p) {
            document.getElementById('prod-id').value = p.id;
            document.getElementById('prod-nome').value = p.nome;
            document.getElementById('prod-desc').value = p.descricao||'';
            document.getElementById('prod-preco').value = p.preco;
            document.getElementById('prod-cat').value = p.categoria_slug;
            document.getElementById('prod-img').value = p.imagem_url;
            document.getElementById('prod-img-file').value = ""; // Limpa file
            if(p.imagem_url) { document.getElementById('img-preview').src = p.imagem_url; document.getElementById('box-preview').style.display = 'block'; }
            
            document.getElementById('prod-montavel').checked = p.e_montavel;
            document.getElementById('builder-steps').innerHTML = '';
            toggleBuilder();
            if(p.montagem_config) p.montagem_config.forEach(e => addBuilderStep(e.titulo, e.max, e.itens));
            document.getElementById('modal-produto').style.display = 'flex';
        }

        function abrirModalProduto() {
            document.getElementById('prod-id').value=''; document.getElementById('prod-nome').value=''; document.getElementById('prod-preco').value='';
            document.getElementById('prod-img').value=''; document.getElementById('prod-img-file').value=''; document.getElementById('box-preview').style.display='none';
            document.getElementById('prod-montavel').checked=false; toggleBuilder();
            document.getElementById('modal-produto').style.display='flex';
        }
        
        async function deletarProduto(id) { if(confirm("Excluir?")) { await supa.from('produtos').delete().eq('id', id); carregarProdutos(); } }
        function toggleBuilder() { document.getElementById('builder-area').style.display = document.getElementById('prod-montavel').checked ? 'block' : 'none'; }
        function addBuilderStep(t='', m=1, i=[]) {
            const div = document.createElement('div'); div.className = 'etapa-item';
            div.innerHTML = `<div class="etapa-header"><input type="text" class="form-control step-titulo" value="${t}" placeholder="T√≠tulo"><input type="number" class="form-control step-max" value="${m}" style="width:70px"><button class="btn btn-sm btn-danger" onclick="this.parentElement.parentElement.remove()">X</button></div><textarea class="etapa-ingredientes step-itens">${i.join(', ')}</textarea>`;
            document.getElementById('builder-steps').appendChild(div);
        }

        // --- CATEGORIAS, MOTOBOYS E CONFIG ---
        // (Mantive suas fun√ß√µes auxiliares simplificadas aqui, mas se quiser pode expandir)
        async function carregarSelectCategorias() {
            const { data } = await supa.from('categorias').select('*').order('ordem');
            const sel = document.getElementById('prod-cat'); sel.innerHTML = '';
            data.forEach(c => sel.innerHTML += `<option value="${c.slug}">${c.nome_exibicao}</option>`);
        }
        async function carregarCategorias() {
            const { data } = await supa.from('categorias').select('*').order('ordem');
            const tb = document.getElementById('lista-categorias'); tb.innerHTML = '';
            data.forEach(c => tb.innerHTML += `<tr><td>${c.slug}</td><td>${c.nome_exibicao}</td><td>${c.ordem}</td><td><button class="btn btn-sm btn-danger" onclick="supa.from('categorias').delete().eq('slug','${c.slug}').then(carregarCategorias)"><i class="fas fa-trash"></i></button></td></tr>`);
        }
        async function salvarCategoria() {
             await supa.from('categorias').upsert([{ slug: document.getElementById('cat-slug').value, nome_exibicao: document.getElementById('cat-nome').value, ordem: document.getElementById('cat-ordem').value }]);
             fecharModal('modal-cat'); carregarCategorias();
        }
        function abrirModalCategoria() { document.getElementById('modal-cat').style.display='flex'; }

        async function carregarMotoboys() {
             const { data } = await supa.from('motoboys').select('*');
             const tb = document.getElementById('lista-motos'); tb.innerHTML = '';
             data.forEach(m => tb.innerHTML += `<tr><td>${m.nome}</td><td>${m.telefone}</td><td><button class="btn btn-sm btn-primary" onclick='editarMoto(${JSON.stringify(m)})'>Edit</button></td></tr>`);
        }
        async function carregarMotoboysSelect() {
             const { data } = await supa.from('motoboys').select('*').eq('ativo', true);
             const sel = document.getElementById('sel-motoboy'); sel.innerHTML = '<option value="">Selecione...</option>';
             if(data) data.forEach(m => sel.innerHTML += `<option value="${m.id}" data-tel="${m.telefone}" data-nome="${m.nome}">${m.nome}</option>`);
        }
        function abrirModalMoto() { document.getElementById('moto-id').value=''; document.getElementById('modal-moto').style.display='flex'; }
        function editarMoto(m) { document.getElementById('moto-id').value=m.id; document.getElementById('moto-nome').value=m.nome; document.getElementById('moto-tel').value=m.telefone; document.getElementById('modal-moto').style.display='flex'; }
        async function salvarMotoboy() {
             const dados = { nome: document.getElementById('moto-nome').value, telefone: document.getElementById('moto-tel').value };
             const id = document.getElementById('moto-id').value;
             if(id) await supa.from('motoboys').update(dados).eq('id', id); else await supa.from('motoboys').insert([dados]);
             fecharModal('modal-moto'); carregarMotoboys();
        }

        async function carregarConfiguracoes() {
            const { data } = await supa.from('configuracoes').select('*').single();
            if(data) {
                document.getElementById('cfg-aberta').value = data.loja_aberta.toString();
                document.getElementById('cfg-cotacao').value = data.cotacao_real;
                if(data.hora_abertura) document.getElementById('cfg-hora-abre').value = data.hora_abertura;
                if(data.hora_fechamento) document.getElementById('cfg-hora-fecha').value = data.hora_fechamento;
            }
        }
        async function salvarConfiguracoes() {
             await supa.from('configuracoes').update({
                 loja_aberta: document.getElementById('cfg-aberta').value === 'true',
                 cotacao_real: document.getElementById('cfg-cotacao').value,
                 hora_abertura: document.getElementById('cfg-hora-abre').value,
                 hora_fechamento: document.getElementById('cfg-hora-fecha').value
             }).gt('id', 0);
             alert("Salvo!");
        }

        function toggleTodos(s) { document.querySelectorAll('.check-pedido').forEach(c => c.checked = s.checked); }
        async function calcularFinanceiro() {
            // ... (Sua l√≥gica financeira mantida igual)
            const hoje = new Date().toISOString().split('T')[0];
            const { data: vendas } = await supa.from('pedidos').select('*').eq('status', 'entregue').gte('data_pedido', hoje);
            let totalPix = 0, totalCartao = 0, totalEfetivo = 0, totalGeral = 0, custoMotoboysTotal = 0;
            const motoboysAtivos = new Set();

            if(vendas) {
                vendas.forEach(v => {
                    totalGeral += v.total_geral;
                    if(v.forma_pagamento === 'Pix' || v.forma_pagamento === 'Transferencia') totalPix += v.total_geral;
                    else if(v.forma_pagamento === 'Cartao') totalCartao += v.total_geral;
                    else totalEfetivo += v.total_geral;
                    custoMotoboysTotal += TAXA_MOTOBOY; 
                    if(v.motoboy_id) motoboysAtivos.add(v.motoboy_id);
                });
                custoMotoboysTotal += (motoboysAtivos.size * AJUDA_COMBUSTIVEL);
                document.getElementById('fin-pix').innerText = `Gs ${totalPix.toLocaleString('es-PY')}`;
                document.getElementById('fin-cartao').innerText = `Gs ${totalCartao.toLocaleString('es-PY')}`;
                document.getElementById('fin-efetivo').innerText = `Gs ${totalEfetivo.toLocaleString('es-PY')}`;
                const lucroLiquido = totalGeral - custoMotoboysTotal;
                document.getElementById('fin-liquido').innerText = `Gs ${lucroLiquido.toLocaleString('es-PY')}`;
            }
        }
        async function logout() { await supa.auth.signOut(); window.location.href='login.html'; }
        async function carregarDashboard() {
            const hoje = new Date().toISOString().split('T')[0];
            const { data: pedidos } = await supa.from('pedidos').select('*').gte('data_pedido', hoje).eq('status', 'entregue');
            const total = pedidos ? pedidos.reduce((a,b)=>a+(b.total_geral||0),0) : 0;
            document.getElementById('kpi-vendas').innerText = `Gs ${total.toLocaleString('es-PY')}`;
            document.getElementById('kpi-pedidos').innerText = pedidos ? pedidos.length : 0;
            document.getElementById('kpi-moto').innerText = `Gs ${((pedidos?.length||0)*TAXA_MOTOBOY + (pedidos?.length>0?AJUDA_COMBUSTIVEL:0)).toLocaleString('es-PY')}`;
            const { data: ranking } = await supa.from('produtos').select('nome, vendas_total').order('vendas_total', {ascending:false}).limit(5);
            const tb = document.querySelector('#tabela-ranking tbody'); tb.innerHTML = '';
            if(ranking) ranking.forEach(p => tb.innerHTML += `<tr><td>${p.nome}</td><td>${p.vendas_total}</td></tr>`);
        }
        async function carregarMotoboysSelect() {
            // Busca motoboys ativos no banco
            const { data: motos, error } = await supa
                .from('motoboys')
                .select('*')
                .eq('ativo', true);

            const sel = document.getElementById('sel-motoboy');
            
            // Se o elemento n√£o existir na tela (erro de HTML), para aqui
            if (!sel) return;

            sel.innerHTML = '<option value="">Selecione o Motoboy...</option>';
            
            if (motos) {
                motos.forEach(m => {
                    sel.innerHTML += `<option value="${m.id}" data-tel="${m.telefone}" data-nome="${m.nome}">${m.nome}</option>`;
                });
            }
        }

        function fecharModal(id) { document.getElementById(id).style.display='none'; }
    </script>
</body>
</html>